<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Byr√• 49 - Alla Data</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; max-height: 400px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üîç Debug Byr√• 49 - Alla Data</h1>
    
    <div class="debug-section">
        <h2>1. Risker kopplad till tj√§nster (Byr√• 49)</h2>
        <button onclick="loadRiskAssessments()">Ladda riskbed√∂mningar</button>
        <div id="risk-assessments-result"></div>
    </div>
    
    <div class="debug-section">
        <h2>2. Alla Airtable-tabeller</h2>
        <button onclick="listAllTables()">Lista alla tabeller</button>
        <div id="tables-result"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. S√∂k efter "tj√§nster" eller "services"</h2>
        <button onclick="searchForServices()">S√∂k efter tj√§nster</button>
        <div id="services-result"></div>
    </div>

    <script>
        async function loadRiskAssessments() {
            const resultDiv = document.getElementById('risk-assessments-result');
            resultDiv.innerHTML = '<p>Laddar riskbed√∂mningar...</p>';
            
            try {
                const response = await fetch('http://localhost:3001/api/risk-assessments', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const risks = data.records || [];
                    
                    // Hitta risker f√∂r Byr√• 49
                    const byra49Risks = risks.filter(risk => {
                        const byraId = risk.fields['Byr√• ID'];
                        return byraId && byraId.toString() === '49';
                    });
                    
                    resultDiv.innerHTML = `
                        <p class="success">‚úÖ Riskbed√∂mningar laddade (${risks.length} totalt)</p>
                        <p><strong>Pagination info:</strong> ${data.pagesFetched || 'N/A'} sidor, ${data.totalRecords || 'N/A'} totala poster</p>
                        <h3>Risker f√∂r Byr√• 49 (${byra49Risks.length} st):</h3>
                        ${byra49Risks.length > 0 ? 
                            `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Task Name</th>
                                        <th>Riskbed√∂mning</th>
                                        <th>Aktuell</th>
                                        <th>Beskrivning</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${byra49Risks.map(risk => `
                                        <tr>
                                            <td>${risk.fields['Task Name'] || 'Saknas'}</td>
                                            <td>${risk.fields['Riskbed√∂mning'] || 'Saknas'}</td>
                                            <td>${risk.fields['Aktuell'] ? 'Ja' : 'Nej'}</td>
                                            <td>${(risk.fields['Beskrivning av riskfaktor'] || '').substring(0, 100)}...</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>` :
                            '<p class="warning">‚ö†Ô∏è Inga risker hittades f√∂r Byr√• 49</p>'
                        }
                        <h3>Alla unika byr√•-ID:n i riskdata:</h3>
                        <p>${[...new Set(risks.map(r => r.fields['Byr√• ID']).filter(id => id))].sort((a,b) => a-b).join(', ')}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">‚ùå HTTP ${response.status}: ${response.statusText}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Fel: ${error.message}</p>`;
            }
        }
        
        async function listAllTables() {
            const resultDiv = document.getElementById('tables-result');
            resultDiv.innerHTML = '<p>Laddar tabellista...</p>';
            
            try {
                // F√∂rs√∂k h√§mta alla tillg√§ngliga endpoints
                const endpoints = [
                    '/api/risk-assessments',
                    '/api/users',
                    '/api/byraer',
                    '/api/kunddata',
                    '/api/avvikelser',
                    '/api/utbildningar',
                    '/api/statistik'
                ];
                
                let results = '<h3>Testar tillg√§ngliga API-endpoints:</h3>';
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`http://localhost:3001${endpoint}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const count = data.records ? data.records.length : data.length || 0;
                            results += `<p class="success">‚úÖ ${endpoint}: ${count} poster</p>`;
                            
                            // Om det finns data, visa f√∂rsta posten som exempel
                            if (data.records && data.records.length > 0) {
                                const firstRecord = data.records[0];
                                if (firstRecord.fields && firstRecord.fields['Byr√• ID']) {
                                    const byra49Count = data.records.filter(r => 
                                        r.fields['Byr√• ID'] && r.fields['Byr√• ID'].toString() === '49'
                                    ).length;
                                    results += `<p>  - Byr√• 49: ${byra49Count} poster</p>`;
                                }
                            }
                        } else {
                            results += `<p class="error">‚ùå ${endpoint}: HTTP ${response.status}</p>`;
                        }
                    } catch (error) {
                        results += `<p class="error">‚ùå ${endpoint}: ${error.message}</p>`;
                    }
                }
                
                resultDiv.innerHTML = results;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Fel: ${error.message}</p>`;
            }
        }
        
        async function searchForServices() {
            const resultDiv = document.getElementById('services-result');
            resultDiv.innerHTML = '<p>S√∂ker efter tj√§nster...</p>';
            
            try {
                // Testa olika m√∂jliga tj√§nste-tabeller
                const serviceEndpoints = [
                    '/api/services',
                    '/api/tjanster',
                    '/api/risk-assessments',
                    '/api/kunddata'
                ];
                
                let results = '<h3>S√∂ker efter tj√§nster i olika tabeller:</h3>';
                
                for (const endpoint of serviceEndpoints) {
                    try {
                        const response = await fetch(`http://localhost:3001${endpoint}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const records = data.records || [];
                            
                            // S√∂k efter poster som kan vara tj√§nster
                            const serviceKeywords = ['tj√§nst', 'service', 'uppgift', 'task', 'bokf√∂ring', 'redovisning', 'moms', 'l√∂n'];
                            const potentialServices = records.filter(record => {
                                const fields = record.fields;
                                const allText = JSON.stringify(fields).toLowerCase();
                                return serviceKeywords.some(keyword => allText.includes(keyword));
                            });
                            
                            if (potentialServices.length > 0) {
                                results += `<p class="success">‚úÖ ${endpoint}: ${potentialServices.length} potentiella tj√§nster</p>`;
                                
                                // Visa exempel p√• tj√§nster
                                potentialServices.slice(0, 3).forEach(service => {
                                    const taskName = service.fields['Task Name'] || service.fields['Namn'] || service.fields['Tj√§nst'] || 'Ok√§nt';
                                    const byraId = service.fields['Byr√• ID'];
                                    results += `<p>  - ${taskName} (Byr√•: ${byraId || 'Saknas'})</p>`;
                                });
                            } else {
                                results += `<p>‚ÑπÔ∏è ${endpoint}: ${records.length} poster (inga tj√§nster hittade)</p>`;
                            }
                        } else {
                            results += `<p class="error">‚ùå ${endpoint}: HTTP ${response.status}</p>`;
                        }
                    } catch (error) {
                        results += `<p class="error">‚ùå ${endpoint}: ${error.message}</p>`;
                    }
                }
                
                resultDiv.innerHTML = results;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Fel: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
